import React, { useCallback, useEffect, useMemo } from 'react';
import { useWallet } from '@solana/wallet-adapter-react';
import { WalletName, WalletReadyState } from '@solana/wallet-adapter-base';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { toast } from "sonner";
import { Loader2 } from 'lucide-react';

const WALLET_ICONS: Record<string, React.ReactNode> = {
  'Phantom': (
    <svg width="24" height="24" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Phantom wallet logo">
      <rect width="128" height="128" rx="24" fill="url(#paint0_linear_phantom)"/>
      <path d="M110.584 64.9142H99.142C99.142 41.8335 80.214 23 57 23V34.214C73.786 34.214 87.857 48.2502 87.857 64.9142H76.415C76.415 64.9142 92.513 81.2282 92.8708 81.5619C93.8476 82.5057 95.4417 82.49 96.4348 81.5619L110.584 64.9142Z" fill="white"/>
      <path d="M57 105.829V94.6147C40.214 94.6147 26.143 80.5785 26.143 63.9144H37.585C37.585 63.9144 21.487 47.6005 21.1292 47.2667C20.1524 46.323 18.5583 46.3387 17.5652 47.2667L3.41602 63.9144H14.858C14.858 87.0941 33.786 105.829 57 105.829Z" fill="white"/>
      <defs>
        <linearGradient id="paint0_linear_phantom" x1="0" y1="0" x2="128" y2="128" gradientUnits="userSpaceOnUse">
          <stop stopColor="#9945FF"/>
          <stop offset="1" stopColor="#14F195"/>
        </linearGradient>
      </defs>
    </svg>
  ),
  'Solflare': (
    <svg width="24" height="24" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Solflare wallet logo">
      <rect width="128" height="128" rx="24" fill="#FC9965"/>
      <path d="M92.6292 78.5697C92.6292 83.0645 91.0709 87.2113 88.3038 90.2078L97.9225 99.8265C103.3 94.2077 106.556 86.6696 106.556 78.5697C106.556 70.1282 103.3 63.0317 97.3672 57.2846L88.0261 66.6257C91.0709 69.3445 92.6292 73.7974 92.6292 78.5697Z" fill="white"/>
      <path d="M78.5698 92.6291C73.7975 92.6291 69.3446 91.0709 66.6258 88.0261L57.2847 97.3671C63.0318 103.3 70.0799 106.556 78.5698 106.556C86.4403 106.556 93.7368 103.3 99.4839 98.1803L89.8652 88.3038C86.9687 91.0709 82.822 92.6291 78.5698 92.6291Z" fill="white"/>
      <path d="M75.5232 75.5234C75.5232 77.9181 73.6281 79.8132 71.2334 79.8132C68.7904 79.8132 66.9435 77.9181 66.9435 75.5234C66.9435 73.1287 68.8387 71.2336 71.2334 71.2336C73.6763 71.2336 75.5232 73.1287 75.5232 75.5234Z" fill="white"/>
      <path d="M92.6292 78.5697C92.6292 83.0645 91.0709 87.2113 88.3038 90.2078L97.9225 99.8265C103.3 94.2077 106.556 86.6696 106.556 78.5697C106.556 70.1282 103.3 63.0317 97.3672 57.2846L88.0261 66.6257C91.0709 69.3445 92.6292 73.7974 92.6292 78.5697Z" fill="white"/>
      <path d="M78.5698 92.6291C73.7975 92.6291 69.3446 91.0709 66.6258 88.0261L57.2847 97.3671C63.0318 103.3 70.0799 106.556 78.5698 106.556C86.4403 106.556 93.7368 103.3 99.4839 98.1803L89.8652 88.3038C86.9687 91.0709 82.822 92.6291 78.5698 92.6291Z" fill="white"/>
      <path d="M21.4819 78.5697C21.4819 73.7974 23.0402 69.6506 25.8073 66.654L16.1886 57.0353C10.8111 62.6057 7.55566 70.1921 7.55566 78.5697C7.55566 86.6696 10.8111 93.7661 16.7439 99.5132L26.085 90.1722C23.0402 87.2113 21.4819 82.7584 21.4819 78.5697Z" fill="white"/>
      <path d="M78.5698 21.4818C83.0645 21.4818 87.2113 23.04 90.208 25.807L99.8267 16.1883C94.208 10.8108 86.6699 7.55542 78.5698 7.55542C70.4698 7.55542 63.0317 10.8108 57.1846 16.7436L66.5257 26.0846C69.3446 23.04 73.7975 21.4818 78.5698 21.4818Z" fill="white"/>
      <path d="M90.1724 26.0848L80.8314 16.7436C86.5784 10.8108 93.6267 7.55542 101.445 7.55542C109.315 7.55542 116.612 10.8108 122.359 16.0304L112.74 25.8071C109.844 23.0401 105.697 21.4819 101.445 21.4819C96.6724 21.3835 92.8531 23.04 90.1724 26.0848Z" fill="white"/>
      <path d="M35.4113 78.5697C35.4113 75.5234 36.0343 72.6223 37.1208 69.9417L27.5021 60.323C24.7832 65.6375 23.1767 71.9048 23.1767 78.5697C23.1767 84.9414 24.6832 91.2688 27.3022 96.9687L37.0726 87.1979C36.0343 84.5173 35.4113 81.616 35.4113 78.5697Z" fill="white"/>
      <path d="M78.5698 35.4112C81.6161 35.4112 84.5173 36.0342 87.1979 37.1207L96.8166 27.502C91.5022 24.7831 85.2348 23.1766 78.5698 23.1766C71.6216 23.1766 65.5525 24.6831 59.8527 27.3021L69.6235 37.0724C72.3041 36.0342 75.2054 35.4112 78.5698 35.4112Z" fill="white"/>
      <path d="M87.198 37.0724L97.506 46.8432C100.126 41.1434 101.632 34.8159 101.632 28.4442C101.632 21.4961 100.027 15.2287 97.1797 9.96439L87.4089 20.2724C88.4954 23.2223 89.0701 26.4778 89.0701 29.9383C89.0701 32.5225 88.4471 34.9655 87.198 37.0724Z" fill="white"/>
    </svg>
  ),
  'Backpack': (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Backpack wallet logo">
      <circle cx="12" cy="12" r="12" fill="#0F172A"/>
      <path fillRule="evenodd" clipRule="evenodd" d="M19 8.62963C19 8.28148 18.7179 8 18.3702 8H5.62963C5.28148 8 5 8.28148 5 8.62963V18.3704C5 18.7179 5.28148 19 5.62963 19H18.3704C18.7185 19 19 18.7179 19 18.3704V8.62963ZM8.38889 11.2222C8.38889 10.5475 8.93604 10 9.61111 10H14.3889C15.064 10 15.6111 10.5475 15.6111 11.2222V12.8889C15.6111 13.6694 14.9746 14.1111 14.3889 14.1111H9.61111C8.93604 14.1111 8.38889 13.5636 8.38889 12.8889V11.2222Z" fill="#6366F1"/>
    </svg>
  ),
  'Brave': (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Brave wallet logo">
      <rect width="24" height="24" rx="4" fill="#F3802A"/>
      <path d="M17.8812 15.3266C17.6025 14.8483 16.7223 14.2929 16.7223 14.2929C16.7223 14.2929 16.9356 13.3363 16.9853 12.8581C17.0349 12.3799 17.1841 11.5005 16.9357 10.6978C16.6874 9.89517 16.5134 9.76957 16.1601 9.46606C16.0605 9.38293 15.9611 9.30036 15.8625 9.22164C15.6989 9.08996 15.5274 8.94823 15.3596 8.81216C15.2735 8.74596 15.1859 8.67146 15.097 8.5784C14.7633 8.28279 14.4484 8.00258 14.1533 7.80687C14.0905 7.76414 14.0272 7.72086 13.963 7.67677L13.9626 7.67655C13.8918 7.62846 13.8197 7.57936 13.7462 7.52929C13.4652 7.34414 13.1532 7.1417 12.8217 7.00176C12.7862 6.98526 12.7513 6.9691 12.717 6.9533C12.3478 6.79892 11.8855 6.64167 11.3553 6.64796C10.825 6.65425 10.407 6.91926 10.0385 7.18428C9.99091 7.21844 9.94334 7.2526 9.89577 7.28569C9.5824 7.49783 9.3185 7.75027 9.05459 8.00271C9.01959 8.03608 8.98458 8.06945 8.94958 8.10274C8.68568 8.35518 8.42177 8.60762 8.15787 8.86006C8.12287 8.89344 8.08786 8.92682 8.05286 8.9602C7.68905 9.30763 7.37681 9.61087 7.14423 9.96007C7.01621 10.1535 6.95097 10.3727 6.93722 10.5981C6.92347 10.8234 6.96155 11.0495 7.04869 11.2572C7.13582 11.4649 7.26947 11.6481 7.43974 11.7929C7.61001 11.9376 7.81185 12.0402 8.02972 12.0929C8.09796 12.1108 8.1674 12.124 8.23752 12.1324C8.46602 12.1592 8.69749 12.1508 8.9225 12.1076C8.97037 12.0976 9.01776 12.0858 9.06456 12.0726C9.317 12.004 9.5498 11.8601 9.73626 11.6575C9.88633 11.4868 10.0128 11.2951 10.1123 11.0878C10.207 10.8965 10.277 10.6933 10.3211 10.4841C10.3252 10.465 10.3289 10.4459 10.3325 10.4267C10.3591 10.3104 10.3859 10.1935 10.4339 10.0812C10.4352 10.0785 10.4365 10.0758 10.4379 10.0731C10.4394 10.0703 10.441 10.0675 10.4425 10.0648C10.4906 9.96573 10.5173 9.84883 10.5439 9.73138C10.5531 9.69644 10.5624 9.6614 10.572 9.62613C10.5745 9.6177 10.5771 9.60928 10.5797 9.60086C10.6013 9.52928 10.623 9.45757 10.646 9.38669C10.646 9.38669 10.6955 9.26129 10.7945 9.07439C10.9925 8.70059 11.3877 8.072 12.0299 7.71448C12.1338 7.66021 12.2554 7.64969 12.3671 7.68522C12.4788 7.72075 12.5722 7.79941 12.627 7.90277C12.627 7.90277 13.4725 9.56893 13.5716 9.75583C13.6706 9.94273 13.7697 10.1296 13.7697 10.1296C13.7697 10.1296 13.8348 10.3192 13.7099 10.5926L13.4973 11.0681C13.4973 11.0681 13.1714 11.8138 13.0723 12.0007C12.9733 12.1876 12.9385 12.4835 13.0028 12.9587C13.0028 12.9587 13.3635 14.7374 13.4973 15.2376C13.5146 15.3049 13.5233 15.3739 13.5234 15.4434C13.5234 15.4434 13.5234 17.4129 13.5234 17.6245C13.5234 17.8361 13.4508 17.9854 13.3635 18.0922C13.2761 18.1991 13.1655 18.3242 12.9733 18.3484C12.8628 18.3424 12.7559 18.3044 12.664 18.2388C12.5429 18.1558 12.4448 18.0427 12.3797 17.9108C12.2632 17.7023 12.2264 17.4622 12.2747 17.2331C12.2747 17.2331 12.3499 16.823 12.3797 16.6356C12.3999 16.5015 12.3814 16.3647 12.3272 16.2405C12.3272 16.2405 12.1103 15.8062 12.0112 15.6193C11.9122 15.4324 11.6644 14.5458 11.4911 13.9967C11.3674 13.5186 11.178 13.0887 11.0541 12.6106C11.0541 12.6106 10.9674 12.2445 10.922 12.1122C10.8766 11.98 10.8064 11.8138 10.7074 11.645C10.6083 11.4761 10.5092 11.3555 10.273 11.2487C10.0368 11.1419 9.91085 11.0808 9.67466 11.0808C9.43847 11.0808 9.35275 11.1177 9.1413 11.227C8.92986 11.3363 8.76475 11.5854 8.69067 11.7487C8.61659 11.9121 8.59187 12.1064 8.60486 12.3068C8.60486 12.3068 8.62529 12.946 8.75657 13.5265C8.84824 13.9298 8.98521 14.3168 9.12146 14.6942C9.16866 14.8112 9.21569 14.9273 9.26177 15.0369C9.40356 15.3844 9.53093 15.6462 9.62011 16.0478C9.64784 16.1584 9.67217 16.2674 9.69394 16.3742C9.75618 16.6937 9.81066 16.9714 9.86205 16.9864C9.88363 16.9924 9.90402 17.0029 9.9224 17.0175C9.93961 17.0309 9.95549 17.0464 9.96979 17.0638C9.98408 17.0812 9.9967 17.101 10.0073 17.1225C10.0179 17.144 10.0265 17.167 10.0327 17.1909C10.0389 17.2149 10.0428 17.2396 10.0442 17.2645C10.0455 17.2895 10.0445 17.3145 10.041 17.3391C10.0374 17.3636 10.0316 17.3873 10.0235 17.4097C10.0154 17.4322 10.005 17.4531 9.99259 17.472C9.98018 17.491 9.96578 17.5079 9.9499 17.5224C9.93402 17.5369 9.91684 17.5488 9.89878 17.5578C9.88072 17.5669 9.86195 17.5728 9.8428 17.5756C9.82365 17.5783 9.80431 17.5778 9.78529 17.5741C9.76662 17.5704 9.64966 17.5328 9.52979 17.4705C9.40993 17.4082 9.27638 17.2946 9.13674 17.0193C8.9971 16.7441 8.85746 16.4811 8.69067 16.1084C8.52389 15.7358 8.34405 15.2646 8.19135 14.7934C8.03865 14.3223 7.89901 13.8512 7.75937 13.363C7.70619 13.1967 7.62463 13.0412 7.51882 12.9042C7.51882 12.9042 7.22092 12.5306 6.84511 12.2297C6.79363 12.1904 6.73634 12.1595 6.67535 12.1382C6.49486 12.0728 6.30303 12.0415 6.10972 12.0456C5.95928 12.0441 5.80901 12.0626 5.66329 12.1006C5.61814 12.1165 5.57503 12.1375 5.53471 12.1632C5.24661 12.3171 5.0333 12.4839 4.91237 12.8104C4.87174 12.9172 4.84539 13.03 4.83405 13.145C4.80628 13.4345 4.84302 13.7267 4.94066 14.0007C5.03829 14.2746 5.19413 14.523 5.39707 14.7277C5.39707 14.7277 6.14942 15.4492 6.42267 15.7712C6.69592 16.0932 7.40394 17.1331 7.65113 17.5462C7.89831 17.9593 8.23706 18.1222 8.29807 18.4927C8.34418 18.7683 8.33158 19.0498 8.26102 19.3203C8.19047 19.5909 8.06368 19.8447 7.88801 20.0659C7.71234 20.2871 7.4917 20.4708 7.24112 20.6049C6.99055 20.739 6.71496 20.8204 6.4314 20.845C6.27136 20.8595 6.10296 20.96 6.00724 21.1925C5.91152 21.425 6.01981 21.6451 6.00724 21.755C5.99468 21.8649 6.04311 21.9348 6.14942 21.9717C6.25573 22.0087 6.42267 22.0087 6.44782 22.0331C6.47297 22.0576 6.71941 22.0559 6.96667 22.0034C7.21392 21.9509 7.38087 21.7915 7.56228 21.6451C7.74369 21.4987 7.90006 21.3893 8.08147 21.2429C8.26288 21.0964 8.52389 20.8762 8.75937 20.5542C8.99486 20.2322 9.20728 19.7856 9.34692 19.3134C9.48656 18.8412 9.53094 18.29 9.49058 17.9286C9.45022 17.5671 9.34692 17.1749 9.30656 17.0435C9.2662 16.912 9.30656 16.7778 9.38567 16.6399C9.46478 16.5019 9.56808 16.2372 9.81568 16.0688C10.0633 15.9005 10.3295 15.7967 10.4824 15.7246C10.6353 15.6526 10.7595 15.5561 10.922 15.4293C11.1023 15.2819 11.3027 15.1642 11.5165 15.081C11.5165 15.081 12.273 14.7494 12.446 14.6792C12.6189 14.6089 12.8001 14.4626 12.8001 14.4626C12.8001 14.4626 12.9908 14.2177 13.2145 14.0713C13.4382 13.9248 14.3206 13.3162 14.5443 13.1697C14.7679 13.0233 14.942 12.8889 15.1656 12.6894C15.3892 12.4898 15.5381 12.3259 15.6366 12.1724C15.7352 12.0189 15.7343 11.8798 15.7343 11.6952C15.7339 11.6371 15.7211 11.5796 15.696 11.5262C15.696 11.5262 15.5635 11.2459 15.5134 11.1244C15.4634 11.0029 15.3643 10.873 15.3643 10.873L15.0631 10.3927C15.0631 10.3927 14.8891 10.0936 14.815 9.94274C14.7409 9.79191 14.6419 9.58683 14.6419 9.58683C14.6419 9.58683 14.6023 9.41811 14.6667 9.31129C14.7312 9.20447 14.8798 9.03379 14.9441 8.96308C15.0085 8.89236 15.0979 8.76698 15.2219 8.59827C15.3459 8.42955 16.0982 7.56912 16.6174 7.21161C16.6919 7.16092 16.7623 7.107 16.8283 7.05002C17.0519 6.85051 17.1759 6.6673 17.1764 6.54167C17.1764 6.54167 17.1764 6.5166 17.1514 6.46407C17.0819 6.31858 16.9382 6.22365 16.7814 6.20943C16.7079 6.20006 16.6315 6.2077 16.5625 6.23139C16.447 6.27272 16.3386 6.33019 16.2407 6.40152C15.947 6.60727 15.6614 6.82045 15.3842 7.04077L15.3847 7.04103C14.9995 7.34079 14.5989 7.65067 14.1821 7.93807C14.0346 8.04289 13.8617 8.16535 13.6724 8.30591C13.426 8.48611 13.1868 8.6766 12.9552 8.87612L12.9545 8.87672C12.7232 9.07603 12.5 9.26487 12.2858 9.44223C12.2355 9.48457 12.1851 9.52703 12.1347 9.56965C11.5462 10.0794 10.9731 10.6004 10.4195 11.1252C10.4195 11.1252 10.3205 11.2076 10.2709 11.2565C10.2212 11.3053 10.1967 11.3907 10.1967 11.4518C10.1967 11.5129 10.2212 11.5643 10.2709 11.6131C10.3205 11.662 10.3948 11.6864 10.4691 11.6864C10.5435 11.6864 10.5683 11.662 10.593 11.662C10.6178 11.662 10.7416 11.5765 10.7912 11.5277C10.8409 11.4788 11.1388 11.2181 11.4031 11.0223C11.6674 10.8264 12.2996 10.3804 12.5886 10.1969C12.8775 10.0133 13.1297 9.8547 13.3129 9.73381C13.4961 9.61292 13.8098 9.36128 14.0187 9.21045C14.2276 9.05961 14.4365 8.92695 14.6454 8.7761C14.8543 8.62526 15.0136 8.52556 15.147 8.44128C15.2804 8.357 15.5624 8.14032 15.8063 7.94786C16.0502 7.75541 16.2194 7.61068 16.3279 7.52639C16.4364 7.4421 16.545 7.35781 16.6535 7.27353C16.7621 7.18925 16.8409 7.10496 16.9049 7.04121C16.9687 6.97745 17.0277 6.91368 17.0372 6.87599C17.0466 6.8383 17.0379 6.76379 17.0071 6.7261C16.9763 6.68842 16.9208 6.64965 16.8618 6.64965C16.8027 6.64965 16.7272 6.67565 16.6585 6.70928C16.5898 6.7429 16.4954 6.77244 16.401 6.83621C16.3066 6.89997 16.0791 7.03302 15.8517 7.18386C15.6243 7.3347 15.254 7.57028 14.9654 7.78276C14.6769 7.99523 14.4966 8.16398 14.2841 8.33273C14.0717 8.50148 13.8493 8.6579 13.6628 8.79284C13.4764 8.92779 13.2899 9.06274 13.1035 9.19768C12.917 9.33263 12.7952 9.41691 12.7116 9.51454C12.6281 9.61217 12.5696 9.84775 12.5594 9.97793C12.5594 9.97793 12.5496 10.0493 12.5147 10.1103C12.4799 10.1714 12.413 10.2782 12.3115 10.3349C12.2101 10.3916 12.0236 10.4428 11.8846 10.5159C11.7457 10.589 11.5987 10.6611 11.4351 10.8119C11.2716 10.9628 11.1821 11.0849 11.1076 11.1946C11.0331 11.3043 10.9338 11.4629 10.8842 11.5362C10.8347 11.6095 10.8096 11.7071 10.8096 11.7682C10.8096 11.8293 10.8346 11.8904 10.8842 11.9148C10.9338 11.9393 11.0082 11.9637 11.1077 11.9637C11.207 11.9637 11.241 11.9393 11.2906 11.9149C11.3403 11.8904 11.4641 11.7694 11.5139 11.696C11.5636 11.6226 12.0096 11.1464 12.1494 11.0168C12.2891 10.8873 12.5039 10.6494 12.6344 10.5461C12.7649 10.4428 12.8955 10.3398 13.0261 10.2368C13.1567 10.1338 13.3152 10.0429 13.5121 9.96247C13.709 9.88207 13.8787 9.85367 14.0135 9.81598C14.1483 9.77828 14.2963 9.70286 14.4128 9.63453C14.5293 9.5662 14.6507 9.47734 14.7721 9.38849C14.8934 9.29964 15.0347 9.21078 15.1759 9.12192C15.3171 9.03307 15.4583 8.94422 15.5996 8.85537C15.7408 8.76652 15.882 8.67766 16.0233 8.58881C16.1645 8.49996 16.2809 8.43162 16.375 8.3817C16.4692 8.33178 16.5831 8.28642 16.6772 8.23649C16.7713 8.18657 16.8626 8.16573 17.0507 8.16573C17.2388 8.16573 17.3479 8.21565 17.457 8.26557C17.5662 8.31549 17.6753 8.36541 17.7844 8.41533C17.8935 8.46525 17.9603 8.4902 18.1484 8.5026C18.3364 8.515 18.485 8.43121 18.6198 8.33929C18.7546 8.24738 18.849 8.1555 18.9016 8.04408C18.9543 7.93266 18.9471 7.79971 18.9471 7.63989C18.9471 7.48006 18.8938 7.33903 18.8261 7.2276C18.7584 7.11617 18.6564 7.02597 18.5543 6.93577C18.4522 6.84557 18.343 6.75537 18.2338 6.66517C18.1247 6.57497 18.0155 6.4126 17.9583 6.32932C17.9011 6.24604 17.8487 6.15442 17.8487 6.06279C17.8487 5.97117 17.9487 5.88329 18.0586 5.75642C18.1686 5.62955 18.2685 5.49613 18.3685 5.39893C18.4684 5.30173 18.5884 5.19897 18.6784 5.13963C18.7683 5.08028 18.863 5.02094 18.9578 4.96159C19.0527 4.90224 19.1476 4.80291 19.2424 4.74357C19.3372 4.68422 19.432 4.62487 19.5269 4.56553C19.6217 4.50618 19.7165 4.44683 19.8114 4.38749C19.9062 4.32815 19.9984 4.29045 20.2218 4.19671C20.4453 4.10297 20.6787 3.923 20.7934 3.80546C20.908 3.68793 21.0095 3.44872 21.0696 3.21579C21.1297 2.98285 21.1317 2.74992 21.0718 2.56995C21.0118 2.38998 20.9118 2.26073 20.7705 2.1782C20.6292 2.09567 20.4467 2.06443 20.2627 2.06372C20.0788 2.06302 19.8965 2.0919 19.7559 2.14156C19.6153 2.19122 19.4846 2.26168 19.3539 2.33213C19.2232 2.40259 19.0925 2.47304 18.9618 2.5435C18.831 2.61395 18.7003 2.68441 18.5696 2.75486C18.4389 2.82532 18.2534 2.91701 18.1675 2.97635C18.0815 3.0357 17.9507 3.13462 17.8647 3.23397C17.7788 3.33331 17.6929 3.46864 17.6069 3.60396C17.5209 3.73929 17.3796 3.97223 17.2683 4.13889C17.157 4.30555 17.0358 4.54476 16.954 4.6879C16.8722 4.83104 16.8057 5.0731 16.725 5.24069C16.6442 5.40828 16.5634 5.65034 16.5077 5.81792C16.452 5.98551 16.3712 6.21586 16.3155 6.44972C16.2599 6.68358 16.1891 6.98342 16.1891 7.16339C16.1891 7.34336 16.215 7.60359 16.4147 7.86382C16.6143 8.12405 16.8339 8.32221 17.0436 8.57737C17.2533 8.83252 17.4729 9.08769 17.6825 9.34284C17.8922 9.59799 18.1018 9.85315 18.3115 10.1083C18.5211 10.3635 18.7308 10.6186 18.9404 10.8738C19.15 11.1289 19.1947 11.4656 19.2327 11.6452C19.2707 11.8248 19.2747 12.0045 19.2747 12.184C19.2747 12.3636 19.2436 12.5432 19.2436 12.7227C19.2436 12.9023 19.2747 13.0771 19.3118 13.2614C19.3488 13.4458 19.3969 13.6489 19.4404 13.8317C19.4839 14.0145 19.5495 14.1973 19.6152 14.3801C19.6809 14.5629 19.7466 14.8911 19.818 15.2192C19.8895 15.5474 19.8743 15.7971 19.8482 15.9622C19.8221 16.1272 19.7598 16.2923 19.6976 16.4574C19.6353 16.6224 19.573 16.7875 19.5107 16.9526C19.4485 17.1176 19.3862 17.2827 19.3239 17.4478C19.2616 17.6128 19.216 17.7862 19.1479 17.9543C19.0797 18.1224 19.0116 18.2906 18.9435 18.4587C18.8753 18.6268 18.8072 18.795 18.739 18.9631C18.6708 19.1313 18.6407 19.2932 18.5855 19.4811C18.5304 19.6691 18.4752 19.875 18.42 20.0829C18.3648 20.2908 18.3097 20.4987 18.2545 20.7066C18.1993 20.9145 18.1442 21.1225 18.089 21.3304C18.0338 21.5383 17.9787 21.7462 17.9576 21.8919C17.9365 22.0375 17.9312 22.222 18.0648 22.3455C18.1983 22.469 18.3755 22.4883 18.5794 22.4883C18.7833 22.4883 18.9365 22.3938 19.0897 22.2992C19.2428 22.2047 19.3453 22.0537 19.4096 21.8669C19.474 21.6801 19.5137 21.4326 19.6052 21.1322C19.6968 20.8318 19.8549 20.478 19.9881 20.1873C20.1214 19.8967 20.2546 19.553 20.3879 19.2624C20.5211 18.9717 20.6544 18.7184 20.7082 18.5316C20.762 18.3448 20.8158 18.1053 20.8696 17.9185C20.9234 17.7317 20.9772 17.4923 21.031 17.3055C21.0848 17.1187 21.1386 16.9318 21.1924 16.7451C21.2462 16.5583 21.3 16.3188 21.3538 16.132C21.4076 15.9452 21.4614 15.7057 21.5152 15.5189C21.569 15.3321 21.6035 15.0364 21.6451 14.7313C21.6868 14.4262 21.7286 14.121 21.7703 13.8159C21.8121 13.5108 21.8538 13.2056 21.8196 12.9628C21.7853 12.72 21.6773 12.4359 21.569 12.1945C21.4607 11.9532 21.3524 11.7545 21.2441 11.5559C21.1358 11.3572 21.0275 11.1586 20.9192 10.9599C20.8109 10.7613 20.7026 10.5627 20.5942 10.364C20.4859 10.1654 20.3776 9.96675 20.2693 9.7681C20.161 9.56945 20.0527 9.3708 19.9444 9.17215C19.8361 8.9735 19.7278 8.77485 19.6195 8.5762C19.5111 8.37755 19.4028 8.1789 19.2945 7.98025C19.1862 7.7816 19.1062 7.5437 19.0917 7.41837C19.0773 7.29304 19.0655 7.06011 19.1158 6.85589C19.1662 6.65167 19.1681 6.43135 19.3566 6.26469C19.5451 6.09804 19.7836 6.05257 19.9868 6.0531C20.1899 6.05363 20.3431 6.09804 20.5462 6.17186C20.7494 6.24569 20.8534 6.37102 20.9583 6.49635C21.0631 6.62168 21.1451 6.92152 21.2007 7.14275C21.2563 7.36397 21.3119 7.5852 21.3675 7.80643C21.4231 8.02765 21.4787 8.24888 21.5343 8.47011C21.5899 8.69133 21.6283 8.94056 21.6724 9.13668C21.7164 9.3328 21.7461 9.52892 21.7758 9.72502C21.8055 9.92113 21.8352 10.1172 21.8652 10.3133C21.8951 10.5094 21.9544 10.9826 21.99 11.1787C22.0257 11.3748 22.0614 11.5709 22.097 11.767C22.1327 11.9631 22.1683 12.1592 22.204 12.3553C22.2396 12.5514 22.2988 12.9033 22.3286 13.0994C22.3584 13.2955 22.3881 13.4916 22.4178 13.6877C22.4475 13.8838 22.4772 14.0799 22.5069 14.276C22.5367 14.4721 22.5447 14.6686 22.5176 14.8647C22.4904 15.0608 22.4215 15.3049 22.3526 15.5489C22.2838 15.793 22.2149 16.037 22.146 16.2811C22.0771 16.5252 22.0082 16.7692 21.9346 17.0133C21.8609 17.2573 21.7875 17.5257 21.7038 17.7363C21.62 17.9468 21.5098 18.1529 21.4016 18.359C21.2934 18.5651 21.1852 18.7855 21.077 18.9916C20.9689 19.1977 20.8607 19.4038 20.7526 19.6099C20.6444 19.816 20.4911 20.0394 20.3452 20.2582C20.1993 20.477 20.0534 20.6958 19.9075 20.9146C19.7616 21.1334 19.6157 21.3523 19.4698 21.5711C19.3239 21.7899 19.178 22.0086 19.0321 22.1545C18.8862 22.3003 18.6798 22.4732 18.4412 22.5609C18.2026 22.6486 17.8595 22.758 17.5654 22.729C17.2713 22.7001 16.9511 22.6813 16.6969 22.5255C16.4427 22.3696 16.2394 22.2184 16.0411 21.9305C15.8428 21.6427 15.6297 21.2372 15.5483 21.0023C15.4669 20.7674 15.4351 20.5325 15.4324 20.3026C15.4298 20.0727 15.4013 19.7564 15.437 19.5215C15.4726 19.2866 15.5083 19.0517 15.5439 18.8168C15.5795 18.5819 15.6152 18.347 15.6508 18.1121C15.6865 17.8772 15.7221 17.6423 15.8194 17.4924C15.9166 17.3425 16.0659 17.2403 16.2152 17.1382C16.3645 17.036 16.5639 16.9339 16.7632 16.8318C16.9626 16.7297 17.162 16.6275 17.3613 16.5254C17.5607 16.4233 17.7601 16.3212 17.9594 16.2191C18.1588 16.117 18.3582 16.0148 18.5575 15.9127C18.7569 15.8106 18.9516 15.6469 19.0599 15.4048C19.1681 15.1627 19.164 14.9361 19.1596 14.7095C19.1552 14.4829 19.1508 14.2563 19.1464 14.0297C19.1419 13.8031 19.1598 13.5564 19.0412 13.2948C18.9227 13.0333 18.7302 12.8047 18.5378 12.5762C18.3454 12.3477 17.9605 12.0048 17.8812 15.3266Z" fill="white"/>
    </svg>
  ),
  'MetaMask': (
    <svg width="24" height="24" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="MetaMask wallet logo">
      <rect width="128" height="128" rx="64" fill="#E17726"/>
      <path d="M88.9072 42L64.9072 57.589L68.8373 47.7923L88.9072 42Z" fill="white" fillOpacity="0.85"/>
      <path d="M39.0928 42L62.7833 57.7743L59.1627 47.7923L39.0928 42Z" fill="white"/>
      <path d="M79.4732 78.9386L73.4178 89.8762L86.9333 94.8148L91.1002 79.1239L79.4732 78.9386Z" fill="white"/>
      <path d="M36.9148 79.1239L41.0667 94.8148L54.5822 89.8762L48.5268 78.9386L36.9148 79.1239Z" fill="white"/>
      <path d="M54.0274 65.2103L50.7971 72.2113L64.2076 73.0273L63.5112 58.4977L54.0274 65.2103Z" fill="white"/>
      <path d="M73.9719 65.2106L64.3486 58.3135L63.789 73.0276L77.2029 72.2116L73.9719 65.2106Z" fill="white"/>
      <path d="M54.5822 89.876L63.1609 84.8073L55.9523 79.2092L54.5822 89.876Z" fill="white"/>
      <path d="M64.8391 84.8073L73.4178 89.876L72.0477 79.2092L64.8391 84.8073Z" fill="white"/>
    </svg>
  ),
  'Coinbase': (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Coinbase wallet logo">
      <circle cx="12" cy="12" r="12" fill="#0052FF"/>
      <path fillRule="evenodd" clipRule="evenodd" d="M12.0001 5C8.14021 5 5.00012 8.13983 5 12.0001C5 15.8604 8.14021 19 12.0001 19C15.8603 19 19.0002 15.8598 19 12.0001C19 8.14021 15.8603 5 12.0001 5ZM9.10011 9.65C8.82461 9.65 8.6001 9.87451 8.6001 10.15V13.85C8.6001 14.1255 8.82461 14.35 9.10011 14.35H14.9001C15.1756 14.35 15.4001 14.1255 15.4001 13.85V10.15C15.4001 9.87451 15.1756 9.65 14.9001 9.65H9.10011Z" fill="white"/>
    </svg>
  ),
  'Slope': (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Slope wallet logo">
      <rect width="24" height="24" rx="5" fill="#C860F0"/>
      <path fillRule="evenodd" clipRule="evenodd" d="M5 12L16.5 5L19 13L5 12ZM19 13L7.5 19L5 12L19 13Z" fill="white"/>
    </svg>
  ),
  'Ledger': (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Ledger wallet logo">
      <rect width="24" height="24" fill="black" rx="5"/>
      <path d="M6 6H11.5V18H6V6Z" fill="white"/>
      <path d="M12.5 6H18V11.5H12.5V6Z" fill="white"/>
      <path d="M12.5 12.5H18V18H12.5V12.5Z" fill="white"/>
    </svg>
  ),
  'Unknown': (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Unknown wallet icon">
      <rect width="24" height="24" rx="12" fill="#888888"/>
      <path d="M12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6ZM12.75 15.75H11.25V14.25H12.75V15.75ZM12.75 13.5H11.25C11.25 11.679 13.5 11.7803 13.5 10.5C13.5 9.67157 12.8284 9 12 9C11.1716 9 10.5 9.67157 10.5 10.5H9C9 8.84315 10.3431 7.5 12 7.5C13.6569 7.5 15 8.84315 15 10.5C15 12.321 12.75 12.2197 12.75 13.5Z" fill="white"/>
    </svg>
  )
};

const WalletSelector = () => {
  const { 
    wallets, 
    select, 
    wallet, 
    connect, 
    connecting, 
    connected, 
    disconnect, 
    disconnecting,
    publicKey 
  } = useWallet();

  // Get the ready wallets that can be selected
  const readyWallets = useMemo(() => 
    wallets.filter(wallet => wallet.readyState === WalletReadyState.Installed || 
                            wallet.readyState === WalletReadyState.Loadable), 
  [wallets]);

  const handleSelectWallet = useCallback((name: WalletName) => {
    select(name);
  }, [select]);
  
  const handleConnectWallet = useCallback(async () => {
    try {
      if (wallet && !connecting && !connected) {
        await connect();
        toast.success("Wallet connected successfully!");
      }
    } catch (error: any) {
      console.error('Failed to connect wallet:', error);
      toast.error(`Connection failed: ${error?.message || 'Unknown error'}`);
    }
  }, [wallet, connecting, connected, connect]);

  const handleDisconnectWallet = useCallback(async () => {
    try {
      if (disconnecting) return;
      await disconnect();
      toast.info("Wallet disconnected");
    } catch (error) {
      console.error('Failed to disconnect wallet:', error);
    }
  }, [disconnect, disconnecting]);

  useEffect(() => {
    if (wallet) {
      console.log("Selected wallet:", wallet.adapter.name);
    }
  }, [wallet]);

  const getShortenedAddress = (address: string) => {
    return `${address.slice(0, 4)}...${address.slice(-4)}`;
  };

  const getWalletIcon = (name: string) => {
    const normalizedName = name.toLowerCase();

    if (normalizedName.includes('phantom')) return WALLET_ICONS['Phantom'];
    if (normalizedName.includes('solflare')) return WALLET_ICONS['Solflare'];
    if (normalizedName.includes('backpack')) return WALLET_ICONS['Backpack'];
    if (normalizedName.includes('brave')) return WALLET_ICONS['Brave'];
    if (normalizedName.includes('coinbase')) return WALLET_ICONS['Coinbase'];
    if (normalizedName.includes('slope')) return WALLET_ICONS['Slope']; 
    if (normalizedName.includes('ledger')) return WALLET_ICONS['Ledger'];
    if (normalizedName.includes('metamask')) return WALLET_ICONS['MetaMask'];
    
    return WALLET_ICONS['Unknown'];
  };

  // If connected, show the address and a disconnect button
  if (connected && publicKey) {
    return (
      <div className="flex items-center gap-2">
        <div className="bg-black/30 backdrop-blur-sm text-white text-xs px-3 py-2 rounded-lg border border-white/10">
          <p className="font-mono">{getShortenedAddress(publicKey.toString())}</p>
        </div>
        <Button 
          variant="destructive" 
          size="sm" 
          onClick={handleDisconnectWallet}
          disabled={disconnecting}
          className="text-white shadow-sm hover:shadow-md transition-all"
        >
          {disconnecting ? 'Disconnecting...' : 'Disconnect'}
        </Button>
      </div>
    );
  }

  // If not connected, show the connect options
  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button 
          className="bg-gradient-to-r from-purple-600 to-blue-500 shadow-md hover:shadow-lg hover:from-purple-700 hover:to-blue-600 transition-all flex items-center gap-2"
          disabled={connecting}
        >
          {connecting ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin" />
              <span>Connecting...</span>
            </>
          ) : (
            <span>Connect Wallet</span>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent 
        className="w-64 bg-black/90 backdrop-blur-lg text-white border-white/10 rounded-xl shadow-lg shadow-purple-900/20"
        sideOffset={5}
      >
        {readyWallets.length > 0 ? (
          readyWallets.map((adapter) => (
            <DropdownMenuItem 
              key={adapter.adapter.name}
              onClick={() => {
                handleSelectWallet(adapter.adapter.name);
                handleConnectWallet();
              }}
              disabled={connecting}
              className="cursor-pointer hover:bg-white/10 flex items-center gap-3 px-3 py-3 transition-colors rounded-lg m-1"
            >
              <div className="flex-shrink-0 w-6 h-6" aria-hidden="true">
                {getWalletIcon(adapter.adapter.name)}
              </div>
              <span className="text-base font-medium">
                {adapter.adapter.name} {connecting && wallet?.adapter.name === adapter.adapter.name && '(Connecting...)'}
              </span>
            </DropdownMenuItem>
          ))
        ) : (
          <div className="text-center p-4 text-gray-400">
            <p>No wallet adapters found</p>
            <p className="text-sm mt-1">Please install a Solana wallet extension</p>
          </div>
        )}

        {/* MetaMask - Coming soon */}
        {!readyWallets.some(w => w.adapter.name.toLowerCase().includes('metamask')) && (
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <div className="px-3 py-3 text-sm opacity-50 flex items-center gap-3 cursor-not-allowed m-1">
                  <div className="flex-shrink-0 w-6 h-6" aria-hidden="true">
                    {WALLET_ICONS['MetaMask']}
                  </div>
                  <span className="text-base">MetaMask (Coming soon)</span>
                </div>
              </TooltipTrigger>
              <TooltipContent className="bg-black/90 text-white border-white/10">
                <p>Support coming soon</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        )}

        {/* Instructions for users without wallet */}
        <div className="mt-3 border-t border-white/10 pt-3 px-3 text-xs opacity-80">
          <p>Don't have a wallet yet?</p>
          <a 
            href="https://phantom.app/" 
            target="_blank" 
            rel="noopener noreferrer" 
            className="text-purple-400 hover:text-purple-300 mt-2 block transition-colors flex items-center gap-1"
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
            Install Phantom Wallet
          </a>
          <a 
            href="https://solflare.com/" 
            target="_blank" 
            rel="noopener noreferrer" 
            className="text-purple-400 hover:text-purple-300 mt-2 block transition-colors flex items-center gap-1"
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
            Install Solflare Wallet
          </a>
        </div>
      </DropdownMenuContent>
    </DropdownMenu>
  );
};

export default WalletSelector;
